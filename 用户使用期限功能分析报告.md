# MoeMail 用户使用期限功能分析报告

## 💡 **方案概述**

设置用户使用期限是一个**非常优秀的解决方案**！相比单独管理每个邮箱的有效期，用户级别的期限管理更加高效、实用且易于维护。

## 📊 **当前系统状态分析**

### ❌ **当前不支持的功能**

#### 1. **用户有效期字段**
- **缺失字段**: `users` 表中没有 `expiresAt` 或类似字段
- **当前结构**:
```sql
CREATE TABLE user (
  id TEXT PRIMARY KEY,
  name TEXT,
  email TEXT UNIQUE,
  username TEXT UNIQUE,
  password TEXT,
  max_emails INTEGER,
  created_by TEXT,
  is_admin_created INTEGER DEFAULT 0
  -- 缺少: expires_at 字段
);
```

#### 2. **用户状态管理**
- **缺失字段**: 没有 `status` 或 `enabled` 字段
- **缺失功能**: 无法禁用或暂停用户账户

#### 3. **过期检查机制**
- **缺失中间件**: 认证时不检查用户有效期
- **缺失API**: 没有用户状态验证逻辑

### ✅ **当前已具备的基础**

#### 1. **完善的认证系统**
- **会话管理**: NextAuth.js 完整实现
- **权限控制**: 基于角色的权限系统
- **中间件**: `middleware.ts` 处理API访问控制

#### 2. **用户管理框架**
- **管理API**: `/api/admin/users` 完整的CRUD
- **权限验证**: 皇帝角色可以管理用户
- **数据库支持**: 完整的用户表结构

#### 3. **时间戳处理经验**
- **API Keys**: 已有过期时间处理 (`expiresAt`)
- **邮箱**: 已有过期时间处理 (`expiresAt`)
- **索引优化**: 已有时间戳索引的实现经验

## 🚀 **实现方案设计**

### **方案一: 基础用户期限管理**

#### 1. **数据库扩展**
```sql
-- 添加用户有效期字段
ALTER TABLE user ADD COLUMN expires_at INTEGER; -- timestamp_ms
ALTER TABLE user ADD COLUMN status TEXT DEFAULT 'active'; -- active, expired, disabled

-- 添加索引优化查询
CREATE INDEX user_expires_at_idx ON user(expires_at);
CREATE INDEX user_status_idx ON user(status);
```

#### 2. **用户状态枚举**
```typescript
export const USER_STATUS = {
  ACTIVE: 'active',      // 正常使用
  EXPIRED: 'expired',    // 已过期
  DISABLED: 'disabled',  // 管理员禁用
  SUSPENDED: 'suspended' // 暂停使用
} as const

export type UserStatus = typeof USER_STATUS[keyof typeof USER_STATUS]
```

#### 3. **认证中间件增强**
```typescript
// middleware.ts 增强
export async function middleware(request: Request) {
  const session = await auth()
  if (!session?.user) {
    return NextResponse.json({ error: "未授权" }, { status: 401 })
  }

  // 检查用户状态和有效期
  const userStatus = await checkUserStatus(session.user.id)
  if (!userStatus.isValid) {
    return NextResponse.json(
      { error: userStatus.reason },
      { status: 403 }
    )
  }

  // ... 其他逻辑
}
```

#### 4. **用户状态检查函数**
```typescript
interface UserStatusResult {
  isValid: boolean
  reason?: string
  expiresAt?: Date
  status?: UserStatus
}

export async function checkUserStatus(userId: string): Promise<UserStatusResult> {
  const db = createDb()
  const user = await db.query.users.findFirst({
    where: eq(users.id, userId)
  })

  if (!user) {
    return { isValid: false, reason: "用户不存在" }
  }

  // 检查用户状态
  if (user.status === USER_STATUS.DISABLED) {
    return { isValid: false, reason: "账户已被禁用" }
  }

  if (user.status === USER_STATUS.SUSPENDED) {
    return { isValid: false, reason: "账户已被暂停" }
  }

  // 检查有效期
  if (user.expiresAt && new Date() > user.expiresAt) {
    // 自动更新状态为过期
    await db.update(users)
      .set({ status: USER_STATUS.EXPIRED })
      .where(eq(users.id, userId))

    return { 
      isValid: false, 
      reason: "账户已过期",
      expiresAt: user.expiresAt
    }
  }

  return { 
    isValid: true,
    expiresAt: user.expiresAt,
    status: user.status
  }
}
```

### **方案二: 高级期限管理系统**

#### 1. **期限模板系统**
```typescript
export const EXPIRY_TEMPLATES = [
  { label: '7天试用', value: 7 * 24 * 60 * 60 * 1000 },
  { label: '1个月', value: 30 * 24 * 60 * 60 * 1000 },
  { label: '3个月', value: 90 * 24 * 60 * 60 * 1000 },
  { label: '6个月', value: 180 * 24 * 60 * 60 * 1000 },
  { label: '1年', value: 365 * 24 * 60 * 60 * 1000 },
  { label: '永久', value: 0 }
]
```

#### 2. **批量期限管理**
- 批量设置用户有效期
- 批量延期功能
- 按角色设置默认有效期

#### 3. **自动化管理**
- 即将过期提醒（邮件/站内通知）
- 自动续期规则
- 过期后的宽限期

#### 4. **审计和统计**
- 用户期限变更日志
- 过期用户统计
- 使用时长分析

## 🔧 **技术实现细节**

### **数据库迁移**
```sql
-- 0015_user_expiry_management.sql
ALTER TABLE user ADD COLUMN expires_at INTEGER;
ALTER TABLE user ADD COLUMN status TEXT DEFAULT 'active';
ALTER TABLE user ADD COLUMN last_login_at INTEGER;
ALTER TABLE user ADD COLUMN created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000);

CREATE INDEX user_expires_at_idx ON user(expires_at);
CREATE INDEX user_status_idx ON user(status);
CREATE INDEX user_last_login_idx ON user(last_login_at);
```

### **API接口扩展**

#### 1. **用户管理API增强**
```typescript
// PUT /api/admin/users/{id}
interface UpdateUserRequest {
  maxEmails?: number
  role?: Role
  expiresAt?: number    // 新增: 有效期
  status?: UserStatus   // 新增: 状态
}
```

#### 2. **批量操作API**
```typescript
// POST /api/admin/users/batch
interface BatchUpdateRequest {
  userIds: string[]
  action: 'extend' | 'disable' | 'enable' | 'setExpiry'
  expiryTime?: number
  status?: UserStatus
}
```

### **前端组件扩展**

#### 1. **用户编辑对话框增强**
```typescript
// 添加有效期选择器
<div className="space-y-2">
  <Label>账户有效期</Label>
  <Select value={expiryTemplate} onValueChange={setExpiryTemplate}>
    <SelectContent>
      {EXPIRY_TEMPLATES.map(template => (
        <SelectItem key={template.value} value={template.value.toString()}>
          {template.label}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>

// 添加状态选择器
<div className="space-y-2">
  <Label>账户状态</Label>
  <Select value={userStatus} onValueChange={setUserStatus}>
    <SelectContent>
      <SelectItem value="active">正常</SelectItem>
      <SelectItem value="disabled">禁用</SelectItem>
      <SelectItem value="suspended">暂停</SelectItem>
    </SelectContent>
  </Select>
</div>
```

#### 2. **用户列表显示增强**
- 显示剩余有效期
- 状态标识（正常/即将过期/已过期）
- 快速操作按钮（延期/禁用）

## 📋 **实现优先级**

### **第一阶段: 基础功能 (1-2天)**
1. ✅ **数据库扩展**: 添加 `expires_at` 和 `status` 字段
2. ✅ **用户状态检查**: 实现 `checkUserStatus` 函数
3. ✅ **中间件增强**: 在认证时检查用户状态
4. ✅ **管理界面**: 用户编辑时可设置有效期

### **第二阶段: 管理功能 (2-3天)**
1. 🔄 **批量操作**: 批量设置用户有效期
2. 🔄 **状态管理**: 用户禁用/启用功能
3. 🔄 **期限显示**: 在用户列表中显示剩余时间
4. 🔄 **快速操作**: 一键延期功能

### **第三阶段: 高级功能 (3-5天)**
1. 📊 **提醒系统**: 即将过期通知
2. 📊 **统计分析**: 用户使用情况统计
3. 📊 **自动化**: 自动续期规则
4. 📊 **审计日志**: 操作记录和追踪

## 💡 **方案优势**

### **1. 集中管理**
- **统一控制**: 一个设置控制用户所有功能
- **简化运维**: 管理员只需管理用户期限
- **批量操作**: 可以批量设置多个用户

### **2. 自动继承**
- **邮箱继承**: 用户过期时，所有邮箱自动失效
- **权限继承**: 用户状态影响所有功能访问
- **API继承**: API Key 也受用户状态影响

### **3. 灵活控制**
- **多种状态**: 正常/过期/禁用/暂停
- **精确时间**: 可设置具体的过期时间
- **即时生效**: 状态变更立即生效

### **4. 用户体验**
- **透明提醒**: 用户可以看到自己的有效期
- **宽限期**: 可设置过期后的宽限期
- **续期申请**: 用户可申请延期

## 🎯 **与邮箱期限的对比**

| 特性 | 用户期限管理 | 邮箱期限管理 |
|------|-------------|-------------|
| **管理复杂度** | 🟢 低 - 一次设置 | 🔴 高 - 逐个管理 |
| **运维效率** | 🟢 高 - 批量操作 | 🔴 低 - 单独操作 |
| **用户理解** | 🟢 直观 - 账户概念 | 🟡 复杂 - 多个期限 |
| **技术实现** | 🟢 简单 - 认证层控制 | 🟡 复杂 - 查询层过滤 |
| **性能影响** | 🟢 小 - 一次检查 | 🟡 中等 - 每次查询 |
| **扩展性** | 🟢 好 - 影响所有功能 | 🔴 差 - 仅影响邮箱 |

## 🎉 **总结**

用户使用期限管理是一个**极其优秀的方案**：

### ✅ **强烈推荐的原因**
1. **架构优雅**: 在认证层统一控制，影响所有功能
2. **管理高效**: 一次设置控制用户所有权限
3. **实现简单**: 基于现有认证系统，改动最小
4. **用户友好**: 概念清晰，易于理解

### 🚀 **实现建议**
1. **优先实现**: 建议优先实现用户期限管理
2. **分阶段**: 先实现基础功能，再逐步完善
3. **向后兼容**: 现有用户默认设为永久有效

### 📈 **预期效果**
- **管理效率提升 80%**: 批量操作代替逐个管理
- **系统性能优化**: 认证层控制比查询层过滤更高效
- **用户体验改善**: 清晰的账户状态和期限显示

**结论**: 用户使用期限管理是最佳解决方案，建议立即实施！🎯
