/**
 * æµ‹è¯•è‡ªåŠ¨é‚®ç®±ç”ŸæˆåŠŸèƒ½
 * è¿™ä¸ªè„šæœ¬å°†æµ‹è¯•æˆ‘ä»¬å®ç°çš„è‡ªåŠ¨é‚®ç®±ç”ŸæˆåŠŸèƒ½
 */

const BASE_URL = 'http://localhost:3000';

// æµ‹è¯•æ•°æ®
const testUser = {
  username: 'testuser001',
  password: 'password123',
  role: 'knight',
  maxEmails: 5,
  email: 'test@example.com'
};

async function makeRequest(url, options = {}) {
  try {
    const response = await fetch(url, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    const data = await response.json();
    return { response, data };
  } catch (error) {
    console.error('Request failed:', error);
    return { error };
  }
}

async function testUserCreation() {
  console.log('ğŸ§ª æµ‹è¯•ç”¨æˆ·åˆ›å»ºå’Œè‡ªåŠ¨é‚®ç®±ç”Ÿæˆ...');
  
  // 1. å°è¯•åˆ›å»ºç”¨æˆ·ï¼ˆéœ€è¦çš‡å¸æƒé™ï¼‰
  console.log('ğŸ“ åˆ›å»ºæµ‹è¯•ç”¨æˆ·...');
  const { response, data, error } = await makeRequest(`${BASE_URL}/api/admin/users`, {
    method: 'POST',
    body: JSON.stringify(testUser)
  });
  
  if (error) {
    console.error('âŒ è¯·æ±‚å¤±è´¥:', error);
    return;
  }
  
  console.log('ğŸ“Š å“åº”çŠ¶æ€:', response.status);
  console.log('ğŸ“‹ å“åº”æ•°æ®:', JSON.stringify(data, null, 2));
  
  if (response.ok) {
    console.log('âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ!');
    console.log(`ğŸ“§ è‡ªåŠ¨ç”Ÿæˆäº† ${data.emailGeneration?.generatedCount || 0} ä¸ªé‚®ç®±`);
    
    // 2. è·å–ç”¨æˆ·åˆ—è¡¨éªŒè¯
    console.log('\nğŸ“‹ è·å–ç”¨æˆ·åˆ—è¡¨éªŒè¯...');
    const { response: listResponse, data: listData } = await makeRequest(`${BASE_URL}/api/admin/users`);
    
    if (listResponse.ok) {
      console.log('âœ… ç”¨æˆ·åˆ—è¡¨è·å–æˆåŠŸ!');
      const createdUser = listData.users?.find(u => u.username === testUser.username);
      if (createdUser) {
        console.log('ğŸ‘¤ æ‰¾åˆ°åˆ›å»ºçš„ç”¨æˆ·:', {
          id: createdUser.id,
          username: createdUser.username,
          role: createdUser.role,
          maxEmails: createdUser.maxEmails,
          isAdminCreated: createdUser.isAdminCreated
        });
      }
    }
  } else {
    console.log('âŒ ç”¨æˆ·åˆ›å»ºå¤±è´¥:', data.error || 'æœªçŸ¥é”™è¯¯');
    
    if (response.status === 403) {
      console.log('ğŸ’¡ æç¤º: éœ€è¦çš‡å¸æƒé™æ‰èƒ½åˆ›å»ºç”¨æˆ·');
      console.log('ğŸ’¡ è¯·å…ˆåœ¨æµè§ˆå™¨ä¸­ç™»å½•çš‡å¸è´¦å·ï¼Œç„¶åé‡æ–°è¿è¡Œæµ‹è¯•');
    }
  }
}

async function testEmailList() {
  console.log('\nğŸ§ª æµ‹è¯•é‚®ç®±åˆ—è¡¨åŠŸèƒ½...');
  
  const { response, data, error } = await makeRequest(`${BASE_URL}/api/emails`);
  
  if (error) {
    console.error('âŒ è¯·æ±‚å¤±è´¥:', error);
    return;
  }
  
  console.log('ğŸ“Š å“åº”çŠ¶æ€:', response.status);
  
  if (response.ok) {
    console.log('âœ… é‚®ç®±åˆ—è¡¨è·å–æˆåŠŸ!');
    console.log(`ğŸ“§ æ‰¾åˆ° ${data.emails?.length || 0} ä¸ªé‚®ç®±`);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨ç”Ÿæˆçš„é‚®ç®±
    const autoEmails = data.emails?.filter(email => email.isAutoGenerated) || [];
    console.log(`ğŸ¤– å…¶ä¸­ ${autoEmails.length} ä¸ªæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„é‚®ç®±`);
    
    if (autoEmails.length > 0) {
      console.log('ğŸ“‹ è‡ªåŠ¨ç”Ÿæˆçš„é‚®ç®±åˆ—è¡¨:');
      autoEmails.forEach((email, index) => {
        console.log(`  ${index + 1}. ${email.address} (åºå·: ${email.emailSequence})`);
      });
    }
  } else {
    console.log('âŒ é‚®ç®±åˆ—è¡¨è·å–å¤±è´¥:', data.error || 'æœªçŸ¥é”™è¯¯');
    
    if (response.status === 401) {
      console.log('ğŸ’¡ æç¤º: éœ€è¦ç™»å½•æ‰èƒ½æŸ¥çœ‹é‚®ç®±åˆ—è¡¨');
    }
  }
}

async function testEmailCreation() {
  console.log('\nğŸ§ª æµ‹è¯•æ‰‹åŠ¨åˆ›å»ºé‚®ç®±ï¼ˆåº”è¯¥è¢«ç¦æ­¢ï¼‰...');
  
  const { response, data, error } = await makeRequest(`${BASE_URL}/api/emails/generate`, {
    method: 'POST',
    body: JSON.stringify({
      name: 'test',
      domain: 'moemail.app',
      expiresIn: '1h'
    })
  });
  
  if (error) {
    console.error('âŒ è¯·æ±‚å¤±è´¥:', error);
    return;
  }
  
  console.log('ğŸ“Š å“åº”çŠ¶æ€:', response.status);
  console.log('ğŸ“‹ å“åº”æ•°æ®:', JSON.stringify(data, null, 2));
  
  if (response.status === 403) {
    console.log('âœ… æ­£ç¡®! æ™®é€šç”¨æˆ·æ— æ³•æ‰‹åŠ¨åˆ›å»ºé‚®ç®±');
  } else if (response.ok) {
    console.log('âš ï¸  è­¦å‘Š: ç”¨æˆ·ä»ç„¶å¯ä»¥æ‰‹åŠ¨åˆ›å»ºé‚®ç®±ï¼ˆå¯èƒ½æ˜¯çš‡å¸æƒé™ï¼‰');
  } else {
    console.log('âŒ æ„å¤–çš„å“åº”çŠ¶æ€');
  }
}

async function runTests() {
  console.log('ğŸš€ å¼€å§‹æµ‹è¯• MoeMail è‡ªåŠ¨é‚®ç®±ç”ŸæˆåŠŸèƒ½\n');
  console.log('ğŸŒ æµ‹è¯•æœåŠ¡å™¨:', BASE_URL);
  console.log('â° æµ‹è¯•æ—¶é—´:', new Date().toLocaleString());
  console.log('=' .repeat(50));
  
  // æµ‹è¯•é‚®ç®±åˆ—è¡¨ï¼ˆä¸éœ€è¦ç‰¹æ®Šæƒé™ï¼‰
  await testEmailList();
  
  // æµ‹è¯•æ‰‹åŠ¨åˆ›å»ºé‚®ç®±ï¼ˆåº”è¯¥è¢«ç¦æ­¢ï¼‰
  await testEmailCreation();
  
  // æµ‹è¯•ç”¨æˆ·åˆ›å»ºï¼ˆéœ€è¦çš‡å¸æƒé™ï¼‰
  await testUserCreation();
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ æµ‹è¯•å®Œæˆ!');
  console.log('\nğŸ’¡ æµ‹è¯•è¯´æ˜:');
  console.log('1. å¦‚æœçœ‹åˆ° 403 æƒé™é”™è¯¯ï¼Œè¯´æ˜æƒé™æ§åˆ¶æ­£å¸¸å·¥ä½œ');
  console.log('2. è¦å®Œæ•´æµ‹è¯•ç”¨æˆ·åˆ›å»ºåŠŸèƒ½ï¼Œéœ€è¦å…ˆåœ¨æµè§ˆå™¨ä¸­ç™»å½•çš‡å¸è´¦å·');
  console.log('3. å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:3000 è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•');
}

// è¿è¡Œæµ‹è¯•
runTests().catch(console.error);
