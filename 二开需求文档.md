# MoeMail 二次开发需求文档

## 项目概述

MoeMail 是一个基于 Next.js + Cloudflare 技术栈构建的临时邮箱服务，具有完整的用户权限系统、API 接口和 Webhook 集成功能。本文档记录了项目的完整分析结果和二次开发需求。

## 技术架构分析

### 核心技术栈
- **前端框架**: Next.js 15.1.1 (App Router)
- **运行时**: Cloudflare Pages + Edge Runtime
- **数据库**: Cloudflare D1 (SQLite)
- **ORM**: Drizzle ORM
- **认证**: NextAuth.js 5.0 (支持 GitHub OAuth + 用户名密码)
- **样式**: Tailwind CSS + Radix UI
- **状态管理**: Zustand
- **邮件处理**: Cloudflare Email Workers + postal-mime
- **PWA**: next-pwa

### 项目结构
```
moemail/
├── app/                    # Next.js App Router
│   ├── api/               # API 路由
│   │   ├── api-keys/      # API Key 管理
│   │   ├── auth/          # 认证相关
│   │   ├── config/        # 系统配置
│   │   ├── emails/        # 邮箱管理
│   │   ├── roles/         # 角色权限
│   │   └── webhook/       # Webhook 配置
│   ├── components/        # React 组件
│   ├── lib/              # 工具库和配置
│   └── hooks/            # 自定义 Hooks
├── workers/              # Cloudflare Workers
│   ├── email-receiver.ts # 邮件接收处理
│   └── cleanup.ts        # 定时清理任务
├── drizzle/             # 数据库迁移文件
└── scripts/             # 部署和工具脚本
```

### 数据库设计

#### 核心表结构
1. **users** - 用户表 (NextAuth 标准)
2. **accounts** - 第三方账号关联
3. **emails** - 临时邮箱表
4. **messages** - 邮件消息表
5. **webhooks** - Webhook 配置表
6. **roles** - 角色表
7. **userRoles** - 用户角色关联表
8. **apiKeys** - API Key 管理表

#### 权限系统设计
- **四级角色体系**:
  - 皇帝 (Emperor): 网站所有者，拥有所有权限
  - 公爵 (Duke): 超级用户，可使用邮箱、Webhook、API Key
  - 骑士 (Knight): 高级用户，可使用邮箱、Webhook
  - 平民 (Civilian): 普通用户，无权限

## 现有功能分析

### ✅ 已实现的功能

#### 1. 邮箱管理
- 临时邮箱生成 (支持自定义前缀和域名)
- 多种有效期选择 (1小时/1天/7天/永久)
- 自动过期清理机制
- **全局邮箱数量限制**: 皇帝可设置系统级最大邮箱数量

#### 2. 邮件处理
- **接收**: Cloudflare Email Workers 自动处理
- **发送**: 基于 Resend 服务的发件功能
- **存储**: 邮件内容存储在 D1 数据库

#### 3. 权限控制
- 基于角色的访问控制 (RBAC)
- 细粒度权限管理
- **角色提升**: 皇帝可以搜索现有用户并修改其角色
- **角色搜索**: 支持通过用户名或邮箱搜索用户

#### 4. Webhook 集成
- 新邮件实时通知
- 可配置的 Webhook URL
- 标准化的消息格式

#### 5. API 服务
- RESTful API 设计
- API Key 认证
- 完整的 OpenAPI 文档

#### 6. 用户注册机制
- **自助注册**: 用户可以通过 `/api/auth/register` 自行注册
- **GitHub OAuth**: 支持 GitHub 第三方登录

### ❌ 缺失的核心功能

#### 1. 皇帝直接添加用户功能
**现状**: 只能搜索现有用户并修改角色，无法创建新用户
**需求**: 皇帝应该能够直接创建新用户并设置初始配置

#### 2. 用户级别的邮箱数量限制
**现状**: 只有全局的 `MAX_EMAILS` 设置，所有用户共享同一限制
**需求**: 每个用户应该有独立的邮箱数量限制配置

#### 3. 用户列表管理界面
**现状**: 没有用户列表展示界面，只能通过搜索查找单个用户
**需求**: 完整的用户管理界面，包括列表、编辑、删除等功能

## 二次开发需求

### 需求优先级

#### 🔴 高优先级 (P0)
1. **皇帝直接添加用户功能**
2. **用户级别邮箱数量限制**
3. **用户列表管理界面**

#### 🟡 中优先级 (P1)
1. **用户批量操作功能**
2. **用户使用统计面板**
3. **管理员操作审计日志**

#### 🟢 低优先级 (P2)
1. **用户导入/导出功能**
2. **用户标签系统**
3. **高级搜索和过滤**

### 详细需求规格

#### 1. 皇帝直接添加用户功能

**功能描述**: 皇帝角色可以直接创建新用户，设置用户名、密码、角色和个人配置

**技术实现**:
- 新增 API: `POST /api/admin/users`
- 新增前端组件: `CreateUserDialog`
- 权限检查: 仅皇帝角色可访问

**API 设计**:
```typescript
POST /api/admin/users
{
  "username": "newuser",
  "password": "password123",
  "role": "knight",
  "maxEmails": 20,
  "email": "user@example.com" // 可选
}

Response:
{
  "success": true,
  "user": {
    "id": "uuid",
    "username": "newuser",
    "role": "knight",
    "maxEmails": 20
  }
}
```

**前端界面**:
- 添加用户表单 (用户名、密码、角色选择、邮箱数量限制)
- 表单验证 (用户名唯一性、密码强度等)
- 成功/失败反馈

#### 2. 用户级别邮箱数量限制

**功能描述**: 每个用户可以有独立的邮箱数量限制，优先级高于全局设置

**数据库扩展**:
```sql
-- 扩展 users 表
ALTER TABLE user ADD COLUMN max_emails INTEGER DEFAULT NULL;
ALTER TABLE user ADD COLUMN created_by TEXT REFERENCES user(id);
ALTER TABLE user ADD COLUMN is_admin_created BOOLEAN DEFAULT FALSE;
```

**逻辑修改**:
```typescript
// 邮箱数量检查逻辑优先级
const userMaxEmails = user.max_emails; // 用户个人限制
const globalMaxEmails = await env.SITE_CONFIG.get("MAX_EMAILS"); // 全局限制
const effectiveLimit = userMaxEmails || globalMaxEmails || EMAIL_CONFIG.MAX_ACTIVE_EMAILS;
```

**前端显示**:
- 邮箱列表显示个人限制: `${current}/${personalLimit} 个邮箱`
- 用户编辑界面可修改个人限制

#### 3. 用户列表管理界面

**功能描述**: 完整的用户管理界面，支持查看、编辑、删除用户

**API 设计**:
```typescript
// 获取用户列表
GET /api/admin/users?page=1&limit=20&search=keyword&role=knight

// 更新用户配置
PUT /api/admin/users/{userId}
{
  "maxEmails": 50,
  "role": "duke"
}

// 删除用户
DELETE /api/admin/users/{userId}
```

**前端组件**:
- `UserListPanel`: 用户列表展示
- `UserEditDialog`: 编辑用户配置
- `UserDeleteConfirm`: 删除确认对话框

**界面功能**:
- 分页显示用户列表
- 搜索和过滤 (按用户名、邮箱、角色)
- 批量操作 (批量修改角色、删除等)
- 用户详情查看 (邮箱使用情况、注册时间等)

## 实施计划

### Phase 1: 基础用户管理 (1-2周)

**目标**: 实现皇帝直接添加用户和用户级别邮箱限制

**任务清单**:
- [ ] 数据库迁移: 添加用户个人配置字段
- [ ] API 开发: 实现用户 CRUD 接口
- [ ] 权限检查: 修改邮箱创建逻辑
- [ ] 前端组件: 添加用户表单
- [ ] 测试: 单元测试和集成测试

**验收标准**:
- 皇帝可以创建新用户并设置角色
- 用户可以有独立的邮箱数量限制
- 邮箱创建时正确检查个人限制

### Phase 2: 管理界面 (1-2周)

**目标**: 完善用户管理界面和用户体验

**任务清单**:
- [ ] 用户列表组件: 展示所有用户及其配置
- [ ] 编辑用户对话框: 修改用户配置的界面
- [ ] 搜索和过滤: 按条件筛选用户
- [ ] 响应式设计: 适配移动端
- [ ] 用户体验优化: 加载状态、错误处理等

**验收标准**:
- 用户列表正确显示所有用户信息
- 可以通过界面编辑用户配置
- 搜索和过滤功能正常工作
- 移动端界面友好

### Phase 3: 高级功能 (1周)

**目标**: 实现批量操作和统计功能

**任务清单**:
- [ ] 批量操作: 批量修改用户角色/配置
- [ ] 用户统计: 用户使用情况统计面板
- [ ] 审计日志: 记录管理员操作日志
- [ ] 性能优化: 大量用户时的性能优化
- [ ] 文档更新: 更新 API 文档和使用说明

**验收标准**:
- 支持批量选择和操作用户
- 统计面板显示准确的使用数据
- 管理员操作有完整的审计记录
- 系统在大量用户时性能良好

## 技术实现细节

### 数据库迁移脚本

```sql
-- 0014_add_user_personal_config.sql
ALTER TABLE user ADD COLUMN max_emails INTEGER DEFAULT NULL;
ALTER TABLE user ADD COLUMN created_by TEXT REFERENCES user(id);
ALTER TABLE user ADD COLUMN is_admin_created BOOLEAN DEFAULT FALSE;
ALTER TABLE user ADD COLUMN created_at_admin INTEGER DEFAULT NULL;
ALTER TABLE user ADD COLUMN notes TEXT DEFAULT NULL;

-- 创建索引
CREATE INDEX idx_user_created_by ON user(created_by);
CREATE INDEX idx_user_is_admin_created ON user(is_admin_created);
```

### API 路由结构

```
app/api/admin/
├── users/
│   ├── route.ts          # GET (列表), POST (创建)
│   └── [id]/
│       ├── route.ts      # GET (详情), PUT (更新), DELETE (删除)
│       └── stats/
│           └── route.ts  # GET (用户统计)
└── audit/
    └── route.ts          # GET (审计日志)
```

### 组件结构

```
app/components/admin/
├── user-management/
│   ├── user-list-panel.tsx
│   ├── create-user-dialog.tsx
│   ├── edit-user-dialog.tsx
│   ├── user-stats-card.tsx
│   └── batch-operations.tsx
└── audit/
    └── audit-log-panel.tsx
```

## 风险评估

### 技术风险
- **数据库迁移**: 需要谨慎处理现有数据
- **权限逻辑**: 复杂的权限检查可能影响性能
- **并发安全**: 多管理员同时操作时的数据一致性

### 业务风险
- **用户体验**: 新功能可能影响现有用户使用
- **数据安全**: 管理员权限过大可能带来安全风险
- **系统稳定性**: 新功能可能引入未知 bug

### 缓解措施
- 充分的测试覆盖 (单元测试、集成测试、E2E 测试)
- 分阶段发布，先在测试环境验证
- 完善的错误处理和日志记录
- 数据库备份和回滚方案

## 测试策略

### 单元测试
- API 接口测试
- 权限检查逻辑测试
- 数据库操作测试

### 集成测试
- 用户创建流程测试
- 邮箱数量限制测试
- 角色权限集成测试

### E2E 测试
- 完整的用户管理流程
- 不同角色的权限验证
- 界面交互测试

## 部署方案

### 开发环境
1. 运行数据库迁移
2. 更新环境变量配置
3. 重启开发服务器

### 生产环境
1. 备份现有数据库
2. 执行数据库迁移
3. 部署新版本代码
4. 验证功能正常
5. 监控系统状态

## 维护计划

### 监控指标
- 用户创建成功率
- 邮箱数量限制命中率
- API 响应时间
- 错误率统计

### 定期维护
- 清理过期的审计日志
- 优化数据库查询性能
- 更新依赖包版本
- 安全漏洞扫描

## 总结

本二开需求主要解决 MoeMail 项目在用户管理方面的不足，通过实现皇帝直接添加用户、用户级别邮箱数量限制和完整的用户管理界面，将大大提升系统的管理能力和用户体验。

整个实施计划预计需要 3-4 周时间，分三个阶段逐步实现。通过合理的技术架构设计和充分的测试验证，可以确保新功能的稳定性和可靠性。