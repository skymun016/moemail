/**
 * è°ƒè¯•ç”¨æˆ·æƒé™è„šæœ¬
 * æ£€æŸ¥ç”¨æˆ·çš„è§’è‰²åˆ†é…å’Œæƒé™æƒ…å†µ
 */

const BASE_URL = 'http://localhost:3000';

async function makeRequest(url, options = {}) {
  try {
    const response = await fetch(url, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    const data = await response.json();
    return { response, data };
  } catch (error) {
    console.error('Request failed:', error);
    return { error };
  }
}

async function debugUserPermissions() {
  console.log('ğŸ” è°ƒè¯•ç”¨æˆ·æƒé™é—®é¢˜...\n');
  
  // 1. æµ‹è¯•è·å–ç”¨æˆ·åˆ—è¡¨
  console.log('ğŸ“‹ æµ‹è¯•è·å–ç”¨æˆ·åˆ—è¡¨...');
  const { response: usersResponse, data: usersData } = await makeRequest(`${BASE_URL}/api/admin/users`);
  
  console.log('çŠ¶æ€ç :', usersResponse.status);
  if (usersResponse.ok) {
    console.log('âœ… ç”¨æˆ·åˆ—è¡¨è·å–æˆåŠŸ');
    console.log('ç”¨æˆ·æ•°é‡:', usersData.users?.length || 0);
    
    if (usersData.users && usersData.users.length > 0) {
      console.log('\nğŸ‘¥ ç”¨æˆ·åˆ—è¡¨:');
      usersData.users.forEach((user, index) => {
        console.log(`  ${index + 1}. ${user.username} (${user.role}) - é‚®ç®±æ•°é‡: ${user.maxEmails || 0}`);
      });
    }
  } else {
    console.log('âŒ ç”¨æˆ·åˆ—è¡¨è·å–å¤±è´¥:', usersData.error);
  }
  
  // 2. æµ‹è¯•é‚®ç®±åˆ—è¡¨è®¿é—®
  console.log('\nğŸ“§ æµ‹è¯•é‚®ç®±åˆ—è¡¨è®¿é—®...');
  const { response: emailsResponse, data: emailsData } = await makeRequest(`${BASE_URL}/api/emails`);
  
  console.log('çŠ¶æ€ç :', emailsResponse.status);
  if (emailsResponse.ok) {
    console.log('âœ… é‚®ç®±åˆ—è¡¨è·å–æˆåŠŸ');
    console.log('é‚®ç®±æ•°é‡:', emailsData.emails?.length || 0);
    
    if (emailsData.emails && emailsData.emails.length > 0) {
      console.log('\nğŸ“® é‚®ç®±åˆ—è¡¨:');
      emailsData.emails.forEach((email, index) => {
        console.log(`  ${index + 1}. ${email.address} (è‡ªåŠ¨ç”Ÿæˆ: ${email.isAutoGenerated ? 'æ˜¯' : 'å¦'})`);
      });
    }
  } else {
    console.log('âŒ é‚®ç®±åˆ—è¡¨è·å–å¤±è´¥:', emailsData.error);
    
    if (emailsResponse.status === 401) {
      console.log('ğŸ’¡ æç¤º: ç”¨æˆ·æœªç™»å½•');
    } else if (emailsResponse.status === 403) {
      console.log('ğŸ’¡ æç¤º: ç”¨æˆ·æ²¡æœ‰æŸ¥çœ‹é‚®ç®±çš„æƒé™');
      console.log('ğŸ’¡ è¿™å¯èƒ½æ˜¯æƒé™é…ç½®é—®é¢˜');
    }
  }
  
  // 3. æµ‹è¯•é…ç½®è·å–
  console.log('\nâš™ï¸  æµ‹è¯•é…ç½®è·å–...');
  const { response: configResponse, data: configData } = await makeRequest(`${BASE_URL}/api/config`);
  
  console.log('çŠ¶æ€ç :', configResponse.status);
  if (configResponse.ok) {
    console.log('âœ… é…ç½®è·å–æˆåŠŸ');
    console.log('é…ç½®ä¿¡æ¯:', JSON.stringify(configData, null, 2));
  } else {
    console.log('âŒ é…ç½®è·å–å¤±è´¥:', configData.error);
  }
}

async function testWithCookies() {
  console.log('\nğŸª å°è¯•ä½¿ç”¨æµè§ˆå™¨ Cookie è¿›è¡Œæµ‹è¯•...');
  console.log('ğŸ’¡ è¯·åœ¨æµè§ˆå™¨ä¸­ç™»å½•åï¼Œå¤åˆ¶ Cookie åˆ°è¿™é‡Œè¿›è¡Œæµ‹è¯•');
  console.log('ğŸ’¡ æˆ–è€…ç›´æ¥åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­è¿è¡Œä»¥ä¸‹ä»£ç :');
  console.log(`
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œ:
fetch('/api/emails')
  .then(r => r.json())
  .then(data => console.log('é‚®ç®±æ•°æ®:', data))
  .catch(err => console.error('é”™è¯¯:', err));

fetch('/api/admin/users')
  .then(r => r.json())
  .then(data => console.log('ç”¨æˆ·æ•°æ®:', data))
  .catch(err => console.error('é”™è¯¯:', err));
  `);
}

async function main() {
  console.log('ğŸš€ MoeMail ç”¨æˆ·æƒé™è°ƒè¯•å·¥å…·');
  console.log('=' .repeat(50));
  
  await debugUserPermissions();
  await testWithCookies();
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ”§ æ•…éšœæ’é™¤å»ºè®®:');
  console.log('1. ç¡®ä¿ç”¨æˆ·å·²æ­£ç¡®ç™»å½•');
  console.log('2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«åˆ†é…äº†æ­£ç¡®çš„è§’è‰²');
  console.log('3. éªŒè¯æƒé™é…ç½®æ˜¯å¦æ­£ç¡®');
  console.log('4. æ£€æŸ¥ä¸­é—´ä»¶é…ç½®æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦çš„è·¯å¾„');
  console.log('5. æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ç½‘ç»œè¯·æ±‚è¯¦æƒ…');
}

main().catch(console.error);
